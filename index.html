<!DOCTYPE html>
<html>
<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
   <script src="https://cdn.jsdelivr.net/pyodide/v0.20.0/full/pyodide.js"></script>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.21/jquery.csv.min.js"></script>
</head>
<body class="bg-body-tertiary">

  <nav class="navbar navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="#">SEND Analysis Tool</a>
        <a class="navbar-brand ms-auto" href="#">
          <img src="d2i_logo.png" alt="Logo" width="20" height="auto" class="d-inline-block align-text-top">
        </a>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-md-6">
        </div>
          <form id="myForm">
            <input type="file" id="csvFile" accept=".csv" class="form-control" multiple/>
            <br />
            <input type="submit" value="Submit" class="btn btn-primary"/>
            <div>
              
              <div class="progress d-none" >
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
              <input type="plot" id="plot_button" value="plot" class="btn btn-primary"/>
            </div>
          </form>
        </div>
   <script>
      const myForm = document.getElementById("myForm");
      const csvFile = document.getElementById("csvFile");
      document.getElementById("plot_button").disabled = true
      
      myForm.addEventListener("submit", function (e) {
         e.preventDefault();
         $(".progress").removeClass('d-none');
         
         const files = csvFile.files;
         const csv_array = []
          Object.keys(files).forEach(i => {
            const file = files[i];
            const reader = new FileReader();
            reader.onload = (e) => {
            const text = e.target.result
            csv_array.push(text)
         };
         reader.readAsText(file);
         window.files = csv_array
         $('.progress-bar').css("width", "10" + '%')

        })
          async function main() {
            let pyodide = await loadPyodide();
            await pyodide.loadPackage(["pandas", "micropip"]);

            // load initial python packages
            await pyodide.runPythonAsync(`
            import pandas as pd
            import js
            from js import files
            import pyodide_js
            import json
            import io
            `)

            $('.progress-bar').css("width", "15" + '%')
            await pyodide.runPythonAsync(` 
            import micropip
            `)
            
            // update progress bar, install plotly
            $('.progress-bar').css("width", "25" + '%')
            await pyodide.runPythonAsync(`
            await micropip.install('plotly==5.0.0')
            import plotly.express as px
            `)

            // update progress bar, data organisation
            $('.progress-bar').css("width", "66" + '%')
            await pyodide.runPythonAsync(`
            dfs = {}
            for i, v in enumerate(files):
              dfs[i] = pd.read_csv(io.StringIO(files[i]))
              print(dfs[i])

            df = px.data.iris()
            fig = px.scatter(df, x="sepal_width", y="sepal_length", color="species")

            js.document.fig = fig
            `);
          pyodide.globals.get("fig")
          $('.progress-bar').css("width", "100" + '%')
          document.getElementById("plot_button").disabled = false  
          }
          main()  
            
      });
   </script>
</body>
</html>