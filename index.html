<!DOCTYPE html>
<html>
<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
   <script src="https://cdn.jsdelivr.net/pyodide/v0.20.0/full/pyodide.js"></script>
   <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-csv/1.0.21/jquery.csv.min.js"></script>
   <script src="https://cdn.plot.ly/plotly-2.1.0.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body class="bg-body-tertiary">

  <nav class="navbar navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="#">SEND Analysis Tool</a>
        <a class="navbar-brand ms-auto" href="#">
          <img src="d2i_logo.png" alt="Logo" width="20" height="auto" class="d-inline-block align-text-top">
        </a>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-md-6">
        </div>
          <form id="myForm">
            <input type="file" id="csvFile" accept=".csv" class="form-control" multiple/>
            <br />
            <input type="submit" value="Submit" class="btn btn-primary">
            
            </input>
            <div> 
              <div class="spinner d-none" >
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
              </div>  
              <div id="plotly-output">Please submit data files.</div>          
            </div>
          </form>
          <button id="print" type="button" class="btn btn-primary" onclick="pdfFunction()">Save to pdf</button>
        </div>
        
   <script>
      window.jsPDF = window.jspdf.jsPDF;

      const myForm = document.getElementById("myForm");
      const csvFile = document.getElementById("csvFile");
      document.getElementById("print").disabled = true
      
      myForm.addEventListener("submit", function (e) {
         e.preventDefault();
         $(".spinner").removeClass('d-none');
         
         const files = csvFile.files;
         const csv_array = []
          Object.keys(files).forEach(i => {
            const file = files[i];
            const reader = new FileReader();
            reader.onload = (e) => {
            const text = e.target.result
            csv_array.push(text)
         };
         reader.readAsText(file);
         window.files = csv_array

        })
          async function main() {
            let pyodide = await loadPyodide();
            await pyodide.loadPackage(["pandas", "micropip"]);
            

            // load initial python packages
            await pyodide.runPythonAsync(` 
            import micropip
            await micropip.install('plotly==5.0.0')
            `)

            await pyodide.runPythonAsync(await (await fetch("https://raw.githubusercontent.com/WillLP-code/pyodide-test/main/python_app.py")).text());
          
        

            // await pyodide.runPythonAsync(`
            // import pandas as pd
            // import js
            // from js import files
            // import pyodide_js
            // import json
            // import io
            // import plotly.express as px
            // `)


            // await pyodide.runPythonAsync(`
            // dfs = {}
            // for i, v in enumerate(files):
            //   dfs[i] = pd.read_csv(io.StringIO(files[i]))

            // df = px.data.iris()
            // fig = px.scatter(df, x="sepal_width", y="sepal_length", color="species")

            // fig = fig.to_html(
            //   include_plotlyjs=False,
            //   full_html=False,
            //   default_height='350px'
            // )

            // js.document.fig = fig
            // `);
          pyodide.globals.get("fig")
          }
          // document.getElementById("print").disabled = false
          
          $(".spinner").addClass('d-none');
          let plotly = document.getElementById("plotly-output")
          render_plot(plotly, document.fig)
       

          function render_plot(container, plot_html) {
            let range = document.createRange();
            range.selectNode(container);
            let documentFragment = range.createContextualFragment(plot_html);
            while (container.hasChildNodes()) {  
              container.removeChild(container.firstChild);
            }
            container.appendChild(documentFragment);
            container.className = "plotly";
          };

          main();  
          
      });

      async function pdfFunction () {
        console.log('stuff is happening')

        var source = window.document.getElementsByTagName("plotly-output");
        var doc = new jsPDF();

        doc.html('some text', {
          callback: function (doc) {
            // doc.save();
          },
          x: 10,
          y: 10
        });

        doc.output("dataurlnewwindow");
      }
   </script>

</body>
</html>